# 🎵 音频转录工具 - 使用说明

## 🚀 快速开始

### 1. 确保环境配置

检查 `.env` 文件中是否有API密钥：
```env
GEMINI_API_KEY=your_api_key_here
GEMINI_MODEL_NAME=gemini-2.0-flash
```

### 2. 运行程序

**最简单的方式**：
```bash
python 启动.py
```

### 3. 输入文件夹路径

程序会提示您输入包含音频文件的文件夹路径，例如：
- `测试`
- `C:\我的音频文件`
- `D:\课程录音`

### 4. 等待处理完成

程序会自动：
- 🔍 **递归扫描**文件夹及其所有子文件夹中的音频文件
- 逐个上传和转录
- 生成对应的SRT字幕文件（保持原有文件夹结构）
- 显示处理进度

## 📁 可用脚本

| 脚本 | 功能 | 使用场景 |
|------|------|----------|
| `启动.py` | 🌟 **推荐** - 最简单的批量处理 | 日常使用 |
| `批量处理.py` | 完整功能版本 | 需要自定义输出文件夹 |
| `重新处理失败文件.py` | 🆕 重新处理失败的文件 | 网络问题导致的失败 |
| `管理失败文件.py` | 🆕 管理失败文件记录 | 清理、合并失败记录 |
| `examples/working_audio_test.py` | 单文件测试 | 验证环境配置 |

## 📋 支持的格式

**输入格式**：
- MP3
- WAV
- M4A
- FLAC
- OGG

**输出格式**：
- SRT 字幕文件

## 🎯 使用示例

### 示例1：简单文件夹

**处理前：**
```
我的课程/
├── 第1课.mp3
├── 第2课.wav
└── 第3课.m4a
```

**处理后：**
```
我的课程/
├── 第1课.mp3
├── 第1课.srt      ← 新生成
├── 第2课.wav
├── 第2课.srt      ← 新生成
├── 第3课.m4a
└── 第3课.srt      ← 新生成
```

### 示例2：包含子文件夹（🆕 支持递归处理）

**处理前：**
```
我的课程/
├── 第一章/
│   ├── 1-1.mp3
│   └── 1-2.mp3
├── 第二章/
│   ├── 2-1.wav
│   └── 2-2.m4a
└── 总结.mp3
```

**处理后：**
```
我的课程/
├── 第一章/
│   ├── 1-1.mp3
│   ├── 1-1.srt    ← 新生成
│   ├── 1-2.mp3
│   └── 1-2.srt    ← 新生成
├── 第二章/
│   ├── 2-1.wav
│   ├── 2-1.srt    ← 新生成
│   ├── 2-2.m4a
│   └── 2-2.srt    ← 新生成
├── 总结.mp3
└── 总结.srt       ← 新生成
```

## ⚙️ 程序特点

- ✅ **稳定的HTTP API**：避免网络连接问题
- ✅ **自动文件命名**：SRT文件与音频文件同名
- ✅ **递归处理**：🆕 自动处理所有子文件夹中的音频文件
- ✅ **保持文件夹结构**：SRT文件保存在与原音频文件相同的位置
- ✅ **批量处理**：一次处理整个文件夹树
- ✅ **进度显示**：实时显示处理状态和文件路径
- ✅ **错误处理**：单个文件失败不影响其他文件
- ✅ **失败文件记录**：🆕 自动保存失败文件的详细信息
- ✅ **重新处理**：🆕 支持重新处理失败的文件
- ✅ **无需手动输入API密钥**：自动从配置文件读取

## 🛠️ 故障排除

### 常见问题

1. **找不到API密钥**
   ```
   ❌ 错误：未找到API密钥
   ```
   **解决方法**：检查 `.env` 文件中的 `GEMINI_API_KEY`

2. **文件夹不存在**
   ```
   ❌ 文件夹不存在: xxx
   ```
   **解决方法**：确认文件夹路径正确

3. **没有找到音频文件**
   ```
   ❌ 在文件夹中没有找到音频文件
   ```
   **解决方法**：确认文件夹中有支持的音频格式

4. **网络连接问题**
   ```
   ❌ 文件上传失败
   HTTPSConnectionPool: Max retries exceeded
   ProxyError: Unable to connect to proxy
   ```
   **解决方法**：
   - 检查网络连接和代理设置
   - 尝试更换网络环境
   - 使用重新处理功能：`python 重新处理失败文件.py`

### 测试环境

如果遇到问题，可以先运行单文件测试：
```bash
python examples/working_audio_test.py
```

## 🔄 失败文件处理

### 自动保存失败信息

当有文件处理失败时，程序会自动在 `failed_files/` 文件夹中保存详细信息：

**每次运行都生成新文件（不覆盖）**：
```
failed_files/
├── failed_files_20250821_143000.json    ← 第一次运行失败
├── failed_list_20250821_143000.txt
├── failed_files_20250821_150000.json    ← 第二次运行失败
├── failed_list_20250821_150000.txt
├── failed_files_20250821_153000.json    ← 第三次运行失败
└── failed_list_20250821_153000.txt
```

**优点**：
- ✅ 保留完整历史记录
- ✅ 不会丢失任何失败信息
- ✅ 便于追踪不同批次的失败情况

### 重新处理失败文件

```bash
python 重新处理失败文件.py
```

程序会：
1. 📋 列出所有失败文件记录
2. 🔍 让您选择要重新处理的记录
3. 🔄 逐个重新处理失败的文件
4. 📊 显示重新处理的结果

### 失败文件信息内容

**JSON文件**包含：
- 处理时间
- 源文件夹路径
- 失败文件的完整信息
- 详细的错误信息

**文本文件**包含：
- 失败文件的路径列表
- 完整的文件路径（便于手动复制）
- 失败时间和错误信息

### 管理失败文件记录

```bash
python 管理失败文件.py
```

功能包括：
1. **📋 查看所有失败记录**：列出历史失败记录
2. **📊 显示失败文件汇总**：按文件夹和错误类型统计
3. **🧹 清理旧记录**：保留最新5个记录，删除其余
4. **🔄 合并所有失败记录**：将多个记录合并为一个

### 失败文件处理策略

**多次运行的情况**：
- 第一次运行：`failed_files_20250821_143000.*`
- 第二次运行：`failed_files_20250821_150000.*`
- 第三次运行：`failed_files_20250821_153000.*`

**推荐做法**：
1. **定期清理**：使用管理工具清理旧记录
2. **合并记录**：将多次失败合并为一个记录
3. **重新处理**：使用最新的失败记录进行重新处理

## 📞 获取API密钥

1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 登录Google账号
3. 点击"Create API Key"
4. 复制API密钥到 `.env` 文件

## ⚙️ 提示词配置

**重要**：程序只使用 `config/default_prompt.txt` 文件中的内容作为提示词。

### 修改提示词

1. **编辑文件**：直接编辑 `config/default_prompt.txt`
2. **保存生效**：保存后重新运行程序即可生效
3. **不要硬编码**：不要在代码中添加提示词

### 提示词要求

- ✅ 文件必须存在且不能为空
- ✅ 建议包含SRT格式要求
- ✅ 可以根据音频内容类型调整
- ✅ 支持中文和英文提示词

### 当前提示词内容

查看当前提示词：
```bash
cat config/default_prompt.txt
```

## 💡 使用技巧

1. **文件大小**：建议单个文件不超过20MB
2. **文件质量**：音频质量越好，转录效果越好
3. **网络环境**：稳定的网络连接有助于提高成功率
4. **批量处理**：可以一次处理多个文件，程序会自动排队处理
5. **提示词优化**：根据音频类型调整 `config/default_prompt.txt` 中的提示词

## 🎉 开始使用

1. 确保API密钥已配置在 `.env` 文件中
2. 运行 `python 启动.py`
3. 输入音频文件夹路径
4. 等待处理完成

就这么简单！🚀

---

**提示**：如果是第一次使用，建议先用 `测试` 文件夹中的样例文件进行测试。
